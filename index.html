<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Mesyuarat Ahli Lembaga Koperasi 2026 - Koperasi Adham</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #334155; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .signature-box {
            background-color: #ffffff;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: crosshair;
        }

        .print-header { display: none; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-header { 
                display: block !important; 
                text-align: center; 
                margin-bottom: 2rem;
                border-bottom: 2px solid #334155;
                padding-bottom: 1rem;
            }
            body { background: white; padding: 0; }
            .glass-card { box-shadow: none; border: none !important; width: 100%; }
            main { margin-top: 0 !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            th, td { border: 1px solid #cbd5e1 !important; padding: 8px !important; }
            th { background-color: #f1f5f9 !important; }
            img { max-height: 80px !important; }
            @page { margin: 1.5cm; }
            .print-details {
                text-align: left;
                display: inline-block;
                margin: 1rem auto;
                font-size: 0.9rem;
                line-height: 1.6;
            }
            #meetingArchiveSection, #adminSettingsSection { display: none !important; }
            #detailedRecordView { display: block !important; }
        }
        
        .table-scroll::-webkit-scrollbar { height: 6px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .archive-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .archive-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- HEADER KHAS UNTUK CETAKAN -->
    <div id="printHeader" class="print-header">
        <img src="https://i.postimg.cc/yNSrvgJJ/Logo-Koperasi-Adham-Al-Husainy-Berhad.png" alt="Logo Koperasi" class="mx-auto h-24 mb-4">
        <h1 id="printMeetingTitle" class="text-xl font-bold uppercase">MESYUARAT AHLI LEMBAGA KOPERASI</h1>
        <h2 class="text-lg font-semibold">Koperasi Adham Al-Husainy Berhad Tahun <span id="printMeetingYear">2026</span></h2>
        
        <div class="print-details border-t border-b border-slate-300 py-2 mt-4 px-4">
            <div><strong>TARIKH:</strong> <span id="printMeetingDate">09 JANUARI 2026</span></div>
            <div><strong>MASA:</strong> <span id="printMeetingTime">08:30 MALAM</span></div>
            <div><strong>TEMPAT:</strong> <span id="printMeetingVenue">657 JALAN STESEN, SUNGAI BAKAP, 14200 SUNGAI JAWI</span></div>
        </div>
        
        <div class="text-sm mt-4 font-bold underline uppercase tracking-widest text-center">Senarai Kehadiran Rasmi</div>
    </div>

    <!-- HEADER SKRIN UTAMA -->
    <header class="bg-slate-900 text-white pb-24 pt-12 px-4 no-print relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 text-[200px] font-bold leading-none select-none pointer-events-none tracking-tighter dyn-meeting-year">2026</div>
        <div class="max-w-5xl mx-auto text-center relative z-10">
            <div class="inline-block p-4 bg-white rounded-2xl shadow-xl mb-6 shadow-blue-900/20">
                <img src="https://i.postimg.cc/yNSrvgJJ/Logo-Koperasi-Adham-Al-Husainy-Berhad.png" 
                     alt="Logo Koperasi" class="h-20 md:h-24 object-contain">
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold mb-2 tracking-tight uppercase dyn-meeting-title">Mesyuarat Ahli Lembaga Koperasi</h1>
            <p class="text-blue-200 text-lg md:text-xl font-medium uppercase tracking-wide">Koperasi Adham Al-Husainy Berhad Tahun <span class="dyn-meeting-year">2026</span></p>
        </div>
    </header>

    <main class="flex-grow px-4 -mt-16 pb-12 w-full max-w-5xl mx-auto z-20 relative">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="grid grid-cols-1 lg:grid-cols-3 gap-6 transition-all duration-300 no-print">
            
            <div class="lg:col-span-2 space-y-4">
                <div class="glass-card rounded-2xl p-6 md:p-8 border-t-4 border-t-blue-600">
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800 tracking-tight">üìã Butiran Mesyuarat</h2>
                        <span id="systemStatus" class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full uppercase tracking-tighter">Menyambung...</span>
                    </div>
                    <p class="text-slate-600 mb-6 leading-relaxed text-sm">
                        Sila semak maklumat mesyuarat di bawah. Semua ahli dikehendaki merekodkan kehadiran sebagai pengesahan rasmi untuk sesi hari ini.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">üìÖ</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Tarikh</div>
                            <div class="font-bold text-slate-800 text-lg dyn-meeting-date">09 JAN 2026</div>
                        </div>
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">‚è∞</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Masa</div>
                            <div class="font-bold text-slate-800 text-lg dyn-meeting-time">08:30 MALAM</div>
                        </div>
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">üìç</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Tempat</div>
                            <div class="font-bold text-slate-800 text-xs leading-tight mb-1 uppercase dyn-meeting-venue">657 JALAN STESEN, SUNGAI BAKAP</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <button onclick="openModal('regModal')" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-6 px-8 rounded-2xl shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1 flex items-center justify-between group">
                        <div class="text-left">
                            <div class="text-xl uppercase font-extrabold tracking-tight">‚úç Rekod Kehadiran</div>
                            <div class="text-blue-200 text-xs font-normal">Klik untuk mendaftar kehadiran anda (<span class="dyn-meeting-date-short">09 Jan 2026</span>)</div>
                        </div>
                        <div class="text-3xl bg-white/20 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-white/30 transition-colors">‚ûú</div>
                    </button>
                </div>
            </div>

            <aside class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center relative overflow-hidden border-t-4 border-t-emerald-500">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-teal-600"></div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 font-bold">Status Kehadiran Semasa</h3>
                <div class="relative mb-4">
                    <span class="text-7xl font-black text-slate-800 tracking-tighter" id="liveCount">0</span>
                    <span class="absolute top-0 right-0 flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
                <p class="text-sm text-slate-500 mb-6 font-medium">Ahli telah mendaftar masuk</p>
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2 overflow-hidden">
                    <div id="liveProgress" class="bg-emerald-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between w-full text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                    <span>Mula</span>
                    <span>Sasaran Kuorum</span>
                </div>
            </aside>
        </div>

        <!-- PANEL ADMIN -->
        <div id="adminPanel" class="hidden space-y-6 mt-6 transition-all duration-300">
            <div class="glass-card p-6 rounded-2xl flex flex-wrap justify-between items-center gap-4 bg-slate-800 text-white no-print shadow-xl">
                <div>
                    <h2 class="text-xl font-bold">üîí Panel Pengurusan Pentadbir</h2>
                    <p class="text-slate-400 text-sm italic font-medium">Urus rekod dan tetapan mesyuarat di sini.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="logout()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold transition-colors border border-slate-600 shadow-sm active:scale-95">Keluar</button>
                </div>
            </div>

            <!-- TAB NAVIGATION -->
            <nav class="flex border-b border-slate-200 no-print">
                <button onclick="switchAdminTab('archive')" id="tabBtnArchive" class="px-6 py-3 font-bold text-sm uppercase tracking-wider tab-active transition-all">Arkib & Rekod</button>
                <button onclick="switchAdminTab('settings')" id="tabBtnSettings" class="px-6 py-3 font-bold text-sm uppercase tracking-wider tab-inactive transition-all">Tetapan Mesyuarat</button>
            </nav>

            <!-- SECTION: SETTINGS -->
            <div id="adminSettingsSection" class="hidden animate-fade-in no-print">
                <div class="glass-card p-8 rounded-2xl space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="font-extrabold text-slate-800 text-lg uppercase tracking-tight">‚öôÔ∏è Tetapan Mesyuarat Semasa</h3>
                        <p class="text-xs text-slate-500 mt-1 uppercase tracking-tight">Perubahan di sini akan dikemas kini pada Dashboard dan PDF rekod pendaftaran semasa.</p>
                    </div>
                    
                    <form id="meetingSettingsForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tajuk Mesyuarat</label>
                            <input type="text" id="setMeetingTitle" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm" placeholder="Cth: Mesyuarat Ahli Lembaga Koperasi">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tahun</label>
                            <input type="number" id="setMeetingYear" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm" placeholder="2026">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tarikh (YYYY-MM-DD)</label>
                            <input type="date" id="setMeetingDate" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Masa</label>
                            <input type="text" id="setMeetingTime" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm" placeholder="08:30 Malam">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tempat / Lokasi</label>
                            <input type="text" id="setMeetingVenue" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm" placeholder="Cth: 657 Jalan Stesen, Sungai Bakap">
                        </div>
                        
                        <div class="md:col-span-2 pt-4">
                            <button type="submit" id="saveSettingsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-extrabold px-8 py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center gap-2">
                                <span>Simpan Perubahan</span>
                                <div id="settingsSpinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SECTION: ARCHIVE -->
            <div id="meetingArchiveSection" class="space-y-4 no-print">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-2 font-extrabold">Pilih Sesi Rekod</h3>
                <div class="grid grid-cols-1 gap-4" id="archiveListContainer"></div>
            </div>

            <div id="detailedRecordView" class="hidden space-y-6 animate-fade-in">
                <button onclick="hideMeetingDetails()" class="no-print flex items-center gap-2 text-blue-600 font-bold text-xs uppercase hover:underline mb-2 px-1">
                    ‚¨Ö Kembali ke Senarai
                </button>
                
                <section class="glass-card p-6 rounded-2xl shadow-none">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div class="bg-blue-600 text-white px-5 py-3 rounded-xl inline-block shadow-md">
                            <h3 id="viewHeaderTitle" class="font-extrabold text-lg uppercase tracking-tight">Senarai Ahli</h3>
                        </div>
                        <div class="flex gap-2 no-print">
                            <button onclick="window.print()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold transition-all border border-slate-200 shadow-sm flex items-center gap-2">
                                <span>üñ® Cetak PDF</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto table-scroll">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs font-bold text-slate-500 uppercase bg-slate-50 border-y border-slate-200">
                                    <th class="py-3 px-4 text-center" style="width: 50px;">Bil</th>
                                    <th class="py-3 px-4">Nama Penuh</th>
                                    <th class="py-3 px-4">Jawatan</th>
                                    <th class="py-3 px-4">Hubungan (Tel/Email)</th>
                                    <th class="py-3 px-4 text-center">T/Tangan</th>
                                    <th class="py-3 px-4 text-right no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="text-sm text-slate-700"></tbody>
                        </table>
                    </div>
                    <div id="noDataMsg" class="hidden text-center py-16 text-slate-400">
                        <div class="text-5xl mb-4 grayscale opacity-50">üìÇ</div>
                        <p class="font-medium uppercase tracking-widest text-xs">Tiada rekod ahli ditemui.</p>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 py-8 mt-auto text-center no-print">
        <p class="text-slate-400 text-xs mb-2 uppercase font-semibold tracking-[0.2em]">&copy; <span class="dyn-meeting-year">2026</span> Koperasi Adham Al-Husainy Berhad. Hak Cipta Terpelihara.</p>
        <button onclick="openModal('loginModal')" class="text-[10px] font-bold text-slate-300 hover:text-slate-600 uppercase tracking-widest transition-all p-2 rounded hover:bg-slate-50">Akses Sistem Pentadbir</button>
    </footer>

    <!-- MODAL PENDAFTARAN -->
    <div id="regModal" class="fixed inset-0 z-50 hidden no-print">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="closeModal('regModal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto flex flex-col transition-all">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm">
                    <h3 class="font-bold text-lg text-slate-800 uppercase">Pendaftaran (<span class="dyn-meeting-date-short">09 Jan 2026</span>)</h3>
                    <button onclick="closeModal('regModal')" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <form id="attendForm" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">Nama Penuh</label>
                        <input type="text" id="inpName" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-inner" placeholder="Nama penuh anda">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">Jawatan</label>
                        <select id="inpPos" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer shadow-inner">
                            <option value="" disabled selected>Pilih Jawatan</option>
                            <option value="Pengerusi">Pengerusi</option>
                            <option value="Timbalan Pengerusi">Timbalan Pengerusi</option>
                            <option value="Setiausaha">Setiausaha</option>
                            <option value="Bendahari">Bendahari</option>
                            <option value="Anggota Lembaga (ALK)">Anggota Lembaga (ALK)</option>
                            <option value="Pemeriksa Kira-Kira">Pemeriksa Kira-Kira</option>
                            <option value="Ahli Biasa">Ahli Biasa</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div id="otherPosContainer" class="hidden animate-fade-in">
                        <label class="block text-[10px] font-bold text-blue-500 uppercase mb-1">Sila Nyatakan Jawatan</label>
                        <input type="text" id="inpOtherPos" class="w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Pengurus">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div><label class="block text-sm font-bold text-slate-500 uppercase mb-1">No. Telefon</label><input type="tel" id="inpPhone" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none shadow-inner" placeholder="01x-xxxxxxx"></div>
                        <div><label class="block text-sm font-bold text-slate-500 uppercase mb-1">Emel</label><input type="email" id="inpEmail" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none shadow-inner" placeholder="nama@email.com"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label class="block text-sm font-bold text-slate-500 uppercase tracking-wider">Tandatangan Rasmi</label><button type="button" id="clearSig" class="text-xs text-red-500 font-bold hover:underline">Padam</button></div>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl h-40 w-full relative signature-box overflow-hidden"><canvas id="sigCanvas" class="w-full h-full"></canvas></div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2 transition-all active:scale-95 shadow-blue-500/20"><span>Hantar Kehadiran</span><div id="spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div></button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div id="loginModal" class="fixed inset-0 z-50 hidden no-print">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeModal('loginModal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center transition-all border-t-8 border-t-slate-800">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">üîê</div><h3 class="font-bold text-xl text-slate-800 mb-2 font-extrabold uppercase tracking-tight">Sistem Pentadbir</h3><div class="space-y-3 mt-6 text-left"><label class="block text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">ID Pengguna</label><input type="text" id="admUser" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm"><label class="block text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">Kata Laluan</label><input type="password" id="admPass" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm"><p id="loginErr" class="hidden text-xs text-red-500 font-bold mt-2">Maklumat log masuk tidak sah.</p></div><div class="mt-8 flex gap-3"><button onclick="attemptLogin()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md active:scale-95 transition-all">Masuk</button><button onclick="closeModal('loginModal')" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-200 transition-all">Batal</button></div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdRqF-OMKS4I7gmiJezid0hl3gUOUTOLY",
            authDomain: "kehadiran-mesyuarat-koadham.firebaseapp.com",
            projectId: "kehadiran-mesyuarat-koadham",
            storageBucket: "kehadiran-mesyuarat-koadham.firebasestorage.app",
            messagingSenderId: "159418583096",
            appId: "1:159418583096:web:e6cc1155d3b1f426003ecd",
            measurementId: "G-VJKVPEM18K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'koperasi-adham-2025'; 

        let currentUser = null;
        let attendanceDataRaw = [];
        let dataUnsubscribe = null;
        let settingsUnsubscribe = null;
        
        let meetingSettings = {
            title: "Mesyuarat Ahli Lembaga Koperasi",
            date: "2026-01-09",
            time: "08:30 Malam",
            venue: "657 JALAN STESEN, SUNGAI BAKAP",
            year: "2026"
        };

        let activeAdminDateFilter = meetingSettings.date;

        const initAuth = async () => {
            const statusEl = document.getElementById('systemStatus');
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    try { await signInWithCustomToken(auth, token); } 
                    catch (e) { await signInAnonymously(auth); }
                } else { await signInAnonymously(auth); }
            } catch (err) {
                statusEl.textContent = "OFFLINE";
                statusEl.className = "px-3 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full uppercase tracking-tighter";
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const statusEl = document.getElementById('systemStatus');
            if(user) {
                statusEl.textContent = "SISTEM AKTIF";
                statusEl.className = "px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full uppercase tracking-tighter transition-all";
                startSettingsListener();
                startDataListener(); 
            }
        });

        function startSettingsListener() {
            if (settingsUnsubscribe) settingsUnsubscribe();
            const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'currentMeeting');
            
            settingsUnsubscribe = onSnapshot(settingsDocRef, (snap) => {
                if (snap.exists()) {
                    meetingSettings = snap.data();
                    updateUIDynamicFields();
                } else {
                    setDoc(settingsDocRef, meetingSettings).catch(e => console.error("Initial Settings Error:", e));
                }
            }, (error) => {
                console.error("Settings Listen Error:", error);
            });
        }

        function updateUIDynamicFields() {
            const titles = document.querySelectorAll('.dyn-meeting-title');
            const years = document.querySelectorAll('.dyn-meeting-year');
            const dates = document.querySelectorAll('.dyn-meeting-date');
            const times = document.querySelectorAll('.dyn-meeting-time');
            const venues = document.querySelectorAll('.dyn-meeting-venue');
            const shortDates = document.querySelectorAll('.dyn-meeting-date-short');

            titles.forEach(el => el.textContent = meetingSettings.title);
            years.forEach(el => el.textContent = meetingSettings.year);
            venues.forEach(el => el.textContent = meetingSettings.venue);
            times.forEach(el => el.textContent = meetingSettings.time);

            const d = new Date(meetingSettings.date);
            const formattedLong = isNaN(d.getTime()) ? meetingSettings.date : d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            const formattedShort = isNaN(d.getTime()) ? meetingSettings.date : d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
            
            dates.forEach(el => el.textContent = formattedLong);
            shortDates.forEach(el => el.textContent = formattedShort);

            // JIKA sedang di dashboard, pastikan pengepala PDF guna tetapan terbaru
            if (document.getElementById('adminPanel').classList.contains('hidden')) {
                refreshPrintHeader(meetingSettings.title, meetingSettings.year, formattedLong, meetingSettings.time, meetingSettings.venue);
            }

            document.getElementById('setMeetingTitle').value = meetingSettings.title;
            document.getElementById('setMeetingYear').value = meetingSettings.year;
            document.getElementById('setMeetingDate').value = meetingSettings.date;
            document.getElementById('setMeetingTime').value = meetingSettings.time;
            document.getElementById('setMeetingVenue').value = meetingSettings.venue;

            updateDashboard();
        }

        function refreshPrintHeader(title, year, date, time, venue) {
            document.getElementById('printMeetingTitle').textContent = title;
            document.getElementById('printMeetingYear').textContent = year;
            document.getElementById('printMeetingDate').textContent = date;
            document.getElementById('printMeetingTime').textContent = time;
            document.getElementById('printMeetingVenue').textContent = venue;
        }

        function startDataListener() {
            if (dataUnsubscribe) dataUnsubscribe();
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendance');
            dataUnsubscribe = onSnapshot(colRef, (snapshot) => {
                attendanceDataRaw = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateDashboard();
                renderArchiveList();
                if(!document.getElementById('detailedRecordView').classList.contains('hidden')) {
                    renderAdminTable();
                }
            });
        }

        function updateDashboard() {
            const currentSessionRecords = attendanceDataRaw.filter(item => {
                if (!item.createdAt) return false;
                const d = new Date(item.createdAt.seconds * 1000);
                return d.toISOString().split('T')[0] === meetingSettings.date;
            });

            const count = currentSessionRecords.length;
            document.getElementById('liveCount').textContent = count;
            const pct = Math.min((count / 30) * 100, 100);
            document.getElementById('liveProgress').style.width = `${pct}%`;
        }

        const canvas = document.getElementById('sigCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        function resizeCanvas() { const rect = canvas.getBoundingClientRect(); canvas.width = rect.width; canvas.height = rect.height; }
        window.addEventListener('resize', resizeCanvas);
        function getPos(e) { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; }
        ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, (e) => { isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); if(e.type === 'touchstart') e.preventDefault(); }, {passive: false}));
        ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, (e) => { if(!isDrawing) return; const pos = getPos(e); ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#0f172a'; ctx.lineTo(pos.x, pos.y); ctx.stroke(); if(e.type === 'touchmove') e.preventDefault(); }, {passive: false}));
        ['mouseup', 'touchend'].forEach(evt => window.addEventListener(evt, () => isDrawing = false));
        document.getElementById('clearSig').onclick = () => ctx.clearRect(0,0, canvas.width, canvas.height);

        const inpPos = document.getElementById('inpPos');
        const otherPosContainer = document.getElementById('otherPosContainer');
        const inpOtherPos = document.getElementById('inpOtherPos');
        inpPos.addEventListener('change', () => { 
            if (inpPos.value === "Lain-lain") { otherPosContainer.classList.remove('hidden'); inpOtherPos.required = true; } 
            else { otherPosContainer.classList.add('hidden'); inpOtherPos.required = false; inpOtherPos.value = ''; } 
        });

        document.getElementById('attendForm').onsubmit = async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const blank = document.createElement('canvas');
            blank.width = canvas.width; blank.height = canvas.height;
            if(canvas.toDataURL() === blank.toDataURL()) { alert("Sila tandatangan terlebih dahulu."); return; }
            const btn = document.getElementById('submitBtn');
            const spin = document.getElementById('spinner');
            btn.disabled = true; spin.classList.remove('hidden');
            try {
                const finalPosition = (inpPos.value === "Lain-lain") ? inpOtherPos.value : inpPos.value;
                const payload = { name: document.getElementById('inpName').value, position: finalPosition, phone: document.getElementById('inpPhone').value, email: document.getElementById('inpEmail').value, signature: canvas.toDataURL(), createdAt: serverTimestamp(), userId: currentUser.uid };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), payload);
                closeModal('regModal'); e.target.reset(); otherPosContainer.classList.add('hidden'); ctx.clearRect(0,0, canvas.width, canvas.height);
                alert("Kehadiran berjaya dihantar. Terima kasih.");
            } catch (err) { console.error("Ralat:", err); }
            finally { btn.disabled = false; spin.classList.add('hidden'); }
        };

        document.getElementById('meetingSettingsForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const btn = document.getElementById('saveSettingsBtn');
            const spin = document.getElementById('settingsSpinner');
            btn.disabled = true; spin.classList.remove('hidden');

            try {
                const newSettings = {
                    title: document.getElementById('setMeetingTitle').value,
                    year: document.getElementById('setMeetingYear').value,
                    date: document.getElementById('setMeetingDate').value,
                    time: document.getElementById('setMeetingTime').value,
                    venue: document.getElementById('setMeetingVenue').value
                };
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'currentMeeting');
                await setDoc(docRef, newSettings);
                alert("Tetapan mesyuarat telah dikemas kini!");
            } catch (err) {
                console.error("Firebase Save Error:", err);
                alert("Gagal mengemas kini tetapan.");
            } finally { btn.disabled = false; spin.classList.add('hidden'); }
        };

        function renderArchiveList() {
            const container = document.getElementById('archiveListContainer');
            container.innerHTML = '';
            const dates = [...new Set(attendanceDataRaw.map(item => {
                if(!item.createdAt) return null;
                return new Date(item.createdAt.seconds * 1000).toISOString().split('T')[0];
            }))].filter(Boolean).sort((a,b) => b.localeCompare(a));

            dates.forEach(dateStr => {
                const isCurrent = dateStr === meetingSettings.date;
                const d = new Date(dateStr);
                const display = d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // Tajuk untuk arkib lama
                let archiveTitle = isCurrent ? meetingSettings.title : (dateStr === "2025-12-30" ? "Mesyuarat ALK Bil 01/2025" : "Rekod Kehadiran");
                let archiveYear = isCurrent ? meetingSettings.year : d.getFullYear();
                let archiveTime = isCurrent ? meetingSettings.time : "08:30 Malam";
                let archiveVenue = isCurrent ? meetingSettings.venue : "657 JALAN STESEN, SUNGAI BAKAP";

                const card = document.createElement('div');
                card.className = `archive-card glass-card p-6 rounded-2xl flex items-center gap-6 border-l-4 ${isCurrent ? 'border-l-blue-600' : 'border-l-slate-300'} shadow-sm`;
                card.onclick = () => showMeetingDetails(dateStr, archiveTitle, archiveYear, display, archiveTime, archiveVenue);
                card.innerHTML = `<div class="w-12 h-12 ${isCurrent ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-600'} rounded-xl flex items-center justify-center text-2xl shadow-inner">${isCurrent ? 'üìÖ' : 'üìÅ'}</div><div class="flex-grow"><h4 class="font-extrabold text-slate-800 text-base uppercase leading-tight">${archiveTitle}</h4><div class="flex flex-wrap gap-x-4 mt-1 text-[10px] text-slate-500 font-bold uppercase tracking-tighter"><span>üìÖ ${display}</span>${isCurrent ? '<span class="text-blue-600 bg-blue-50 px-2 rounded-full border border-blue-100">Sesi Aktif</span>' : ''}</div></div><div class="text-slate-300 text-xl">‚ûú</div>`;
                container.appendChild(card);
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            const filtered = attendanceDataRaw.filter(item => {
                if (!item.createdAt) return false;
                const d = new Date(item.createdAt.seconds * 1000);
                return d.toISOString().split('T')[0] === activeAdminDateFilter;
            });
            filtered.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            if(filtered.length === 0) { document.getElementById('noDataMsg').classList.remove('hidden'); return; }
            document.getElementById('noDataMsg').classList.add('hidden');
            filtered.forEach((item, i) => { 
                const tr = document.createElement('tr'); tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors"; 
                tr.innerHTML = `<td class="py-3 px-4 text-center font-mono text-xs text-slate-400 font-bold">${i + 1}</td><td class="py-3 px-4 font-bold text-slate-700">${item.name}</td><td class="py-3 px-4"><span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-tighter">${item.position}</span></td><td class="py-3 px-4 text-xs font-medium"><div class="text-slate-800">${item.phone}</div><div class="text-slate-400 font-normal lowercase">${item.email}</div></td><td class="py-3 px-4 text-center"><img src="${item.signature}" class="h-10 mx-auto border border-slate-200 bg-white rounded shadow-sm hover:scale-150 transition-transform"></td><td class="py-3 px-4 text-right no-print"><button onclick="window.delEntry('${item.id}')" class="text-slate-300 hover:text-red-500 transition-colors">üóë</button></td>`;
                tbody.appendChild(tr); 
            });
        }

        window.delEntry = async (id) => { if(confirm("Padam rekod pendaftaran ini?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id)); };
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); if(id === 'regModal') setTimeout(resizeCanvas, 300); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); if(id === 'regModal') { otherPosContainer.classList.add('hidden'); document.getElementById('attendForm').reset(); } };
        window.attemptLogin = () => { const u = document.getElementById('admUser').value; const p = document.getElementById('admPass').value; if(u === 'Admin' && p === 'Admin123') { closeModal('loginModal'); document.getElementById('dashboardView').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); switchAdminTab('archive'); } else { document.getElementById('loginErr').classList.remove('hidden'); } };
        window.logout = () => { document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('dashboardView').classList.remove('hidden'); };
        
        window.switchAdminTab = (tab) => {
            const archBtn = document.getElementById('tabBtnArchive'); const setBtn = document.getElementById('tabBtnSettings');
            const archSec = document.getElementById('meetingArchiveSection'); const setSec = document.getElementById('adminSettingsSection');
            const detailSec = document.getElementById('detailedRecordView');
            
            // Bila tukar tab, reset pengepala PDF ke tetapan semasa
            const d = new Date(meetingSettings.date);
            const formattedLong = d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            refreshPrintHeader(meetingSettings.title, meetingSettings.year, formattedLong, meetingSettings.time, meetingSettings.venue);

            if(tab === 'archive') { archBtn.className = "px-6 py-3 font-bold text-sm uppercase tracking-wider tab-active"; setBtn.className = "px-6 py-3 font-bold text-sm uppercase tracking-wider tab-inactive"; archSec.classList.remove('hidden'); setSec.classList.add('hidden'); detailSec.classList.add('hidden'); } 
            else { setBtn.className = "px-6 py-3 font-bold text-sm uppercase tracking-wider tab-active"; archBtn.className = "px-6 py-3 font-bold text-sm uppercase tracking-wider tab-inactive"; setSec.classList.remove('hidden'); archSec.classList.add('hidden'); detailSec.classList.add('hidden'); }
        };

        window.showMeetingDetails = (dateStr, title, year, displayDate, time, venue) => {
            activeAdminDateFilter = dateStr;
            document.getElementById('viewHeaderTitle').textContent = `${title} (${displayDate})`;
            
            // TUKAR PENGEPALA PDF IKUT KONTEKS ARKIB
            refreshPrintHeader(title, year, displayDate.toUpperCase(), time, venue);
            
            document.getElementById('meetingArchiveSection').classList.add('hidden');
            document.getElementById('detailedRecordView').classList.remove('hidden');
            renderAdminTable();
        };

        window.hideMeetingDetails = () => {
            document.getElementById('detailedRecordView').classList.add('hidden');
            document.getElementById('meetingArchiveSection').classList.remove('hidden');
            
            // Reset PDF header balik ke tetapan semasa
            const d = new Date(meetingSettings.date);
            const formattedLong = d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            refreshPrintHeader(meetingSettings.title, meetingSettings.year, formattedLong, meetingSettings.time, meetingSettings.venue);
        };

        initAuth();
    </script>
</body>
</html>
