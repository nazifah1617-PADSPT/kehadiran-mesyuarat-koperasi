<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borang Kehadiran Mesyuarat ALK - Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .signature-pad {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            background-color: #ffffff;
        }
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }
        /* Menggunakan blend mode untuk "menghilangkan" background putih pada logo jika ada */
        .logo-blend {
            mix-blend-mode: multiply;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center loading-overlay hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900"></div>
            <p class="mt-4 text-blue-900 font-medium">Sedang memproses...</p>
        </div>
    </div>

    <!-- Header Section (Warna Biru Cair) -->
    <header class="bg-blue-50 text-blue-900 py-10 px-4 shadow-sm mb-8 border-b border-blue-100">
        <div class="max-w-3xl mx-auto text-center">
            <!-- Logo Section dengan Blend Mode -->
            <img src="https://i.postimg.cc/yNSrvgJJ/Logo-Koperasi-Adham-Al-Husainy-Berhad.png" 
                 alt="Logo Koperasi Adham Al-Husainy Berhad" 
                 class="mx-auto h-24 md:h-32 mb-6 logo-blend"
                 onerror="this.onerror=null; this.alt='Logo Tidak Ditemui';">
                 
            <h1 class="text-2xl md:text-3xl font-bold mb-2 uppercase tracking-tight">Mesyuarat Anggota Lembaga</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-blue-700 mb-6 uppercase">Koperasi Adham Al-Husainy Berhad Bil.01/2025</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm md:text-base border-t border-blue-200 pt-6">
                <div class="flex flex-col">
                    <span class="text-blue-500 uppercase text-xs font-bold tracking-wider">Tarikh</span>
                    <span class="font-medium">30 DISEMBER 2025 (SELASA)</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-blue-500 uppercase text-xs font-bold tracking-wider">Masa</span>
                    <span class="font-medium">08:30 MALAM</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-blue-500 uppercase text-xs font-bold tracking-wider">Tempat</span>
                    <span class="font-medium text-xs md:text-sm">657 JALAN STESEN, SUNGAI BAKAP<br>14200 SUNGAI JAWI</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-2xl mx-auto px-4 w-full">
        
        <!-- Registration Form -->
        <div id="registrationForm" class="bg-white rounded-xl shadow-md p-6 md:p-8 border border-gray-100">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Pendaftaran Kehadiran</h3>
                <span id="statusBadge" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold uppercase tracking-widest">Sistem Aktif</span>
            </div>
            
            <form id="attendanceForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nama Penuh</label>
                    <input type="text" id="name" required placeholder="Masukkan nama penuh"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Jawatan</label>
                    <input type="text" id="position" required placeholder="Contoh: Pengerusi / Setiausaha / ALK"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">No. Telefon</label>
                        <input type="tel" id="phone" required placeholder="012-3456789"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" required placeholder="nama@email.com"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tandatangan</label>
                    <div class="relative">
                        <canvas id="signaturePad" class="signature-pad w-full h-40"></canvas>
                        <button type="button" id="clearBtn" class="absolute top-2 right-2 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs py-1 px-2 rounded transition-colors">
                            Padam
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 italic">*Sila tandatangan di dalam petak di atas</p>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition-all transform active:scale-95 flex items-center justify-center">
                    <span>Hantar Kehadiran</span>
                </button>
            </form>
        </div>

        <!-- Success Message (Hidden) -->
        <div id="successMsg" class="hidden bg-white rounded-xl shadow-md p-10 text-center border border-green-100">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Terima Kasih!</h3>
            <p class="text-gray-600 mt-2">Kehadiran anda telah berjaya disimpan ke pangkalan data awan.</p>
            <button onclick="window.location.reload()" class="mt-6 text-blue-600 font-medium hover:underline">Daftar kehadiran baru</button>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-sm:w-11/12 max-w-sm">
                <h3 class="text-lg font-bold mb-4 text-blue-900">Akses Admin</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-1 font-medium text-gray-700">Username</label>
                        <input type="text" id="adminUser" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm mb-1 font-medium text-gray-700">Password</label>
                        <input type="password" id="adminPass" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    <div id="loginError" class="text-red-500 text-xs hidden">Username atau password salah!</div>
                    <div class="flex space-x-2 pt-2">
                        <button onclick="loginAdmin()" class="flex-1 bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700 transition-colors">Log Masuk</button>
                        <button onclick="toggleAdminLogin()" class="flex-1 bg-gray-200 py-2 rounded font-semibold hover:bg-gray-300 transition-colors">Batal</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard (Hidden) -->
        <div id="adminDashboard" class="hidden mt-8 mb-12">
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Senarai Kehadiran (Awan)</h3>
                        <p class="text-xs text-gray-500" id="lastUpdated">Mengemas kini...</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-medium">Cetak PDF</button>
                        <button onclick="logoutAdmin()" class="bg-red-50 text-red-600 px-4 py-2 rounded text-sm font-medium border border-red-200">Log Keluar</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                <th class="p-3 border-b">Bil</th>
                                <th class="p-3 border-b">Nama</th>
                                <th class="p-3 border-b">Jawatan</th>
                                <th class="p-3 border-b">No. Tel / Email</th>
                                <th class="p-3 border-b">Tandatangan</th>
                                <th class="p-3 border-b no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Content loaded from Firestore -->
                        </tbody>
                    </table>
                </div>
                <div id="noData" class="text-center py-8 text-gray-500 hidden">Tiada rekod dijumpai di pangkalan data.</div>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-auto no-print">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <p class="text-gray-500 text-sm">
                &copy; 2025 Koperasi Adham Al-Husainy Berhad. Hak Cipta Terpelihara.
            </p>
            <!-- Link Admin Login dipindahkan ke bawah hak cipta -->
            <button onclick="toggleAdminLogin()" class="mt-2 text-gray-300 text-[10px] hover:text-gray-500 transition-colors uppercase tracking-widest font-bold">
                Log Masuk Admin
            </button>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'koperasi-adham-2025';

        // State
        let currentUser = null;
        let attendanceData = [];
        let unsubscribe = null;

        // UI Elements
        const loading = document.getElementById('loading');
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // --- AUTHENTICATION ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('statusBadge').textContent = "Ralat Sambungan";
                document.getElementById('statusBadge').className = "text-[10px] bg-red-100 text-red-700 px-2 py-1 rounded-full font-bold uppercase tracking-widest";
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        // --- SIGNATURE LOGIC ---
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * ratio;
            canvas.height = rect.height * ratio;
            ctx.scale(ratio, ratio);
        }

        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            if (e.type === 'touchstart') e.preventDefault();
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            if (e.type === 'touchmove') e.preventDefault();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        window.addEventListener('touchend', stopDrawing);

        document.getElementById('clearBtn').onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        // --- SUBMISSION LOGIC ---
        document.getElementById('attendanceForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return alert("Sila tunggu sehingga sistem disambungkan.");

            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            if (canvas.toDataURL() === blank.toDataURL()) {
                return alert("Sila berikan tandatangan anda.");
            }

            loading.classList.remove('hidden');

            try {
                const data = {
                    name: document.getElementById('name').value,
                    position: document.getElementById('position').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    signature: canvas.toDataURL(),
                    createdAt: serverTimestamp(),
                    userId: currentUser.uid
                };

                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendance');
                await addDoc(colRef, data);

                document.getElementById('registrationForm').classList.add('hidden');
                document.getElementById('successMsg').classList.remove('hidden');
            } catch (error) {
                console.error("Save Error:", error);
                alert("Gagal menyimpan data ke awan. Sila cuba lagi.");
            } finally {
                loading.classList.add('hidden');
            }
        };

        // --- ADMIN DASHBOARD ---
        window.toggleAdminLogin = () => {
            const modal = document.getElementById('adminLoginModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('adminUser').focus();
            }
        };

        window.loginAdmin = () => {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;

            if (user === 'Admin' && pass === 'Admin123') {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('registrationForm').classList.add('hidden');
                document.getElementById('successMsg').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                startDataListener();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        window.logoutAdmin = () => {
            if (unsubscribe) unsubscribe();
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('registrationForm').classList.remove('hidden');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
        };

        function startDataListener() {
            if (!currentUser) return;
            loading.classList.remove('hidden');

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendance');
            
            unsubscribe = onSnapshot(colRef, (snapshot) => {
                attendanceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                attendanceData.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                renderTable();
                document.getElementById('lastUpdated').textContent = `Dikemas kini pada: ${new Date().toLocaleTimeString()}`;
                loading.classList.add('hidden');
            }, (error) => {
                console.error("Listener Error:", error);
                loading.classList.add('hidden');
            });
        }

        function renderTable() {
            const tbody = document.getElementById('attendanceTableBody');
            const noData = document.getElementById('noData');
            tbody.innerHTML = '';

            if (attendanceData.length === 0) {
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            attendanceData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 text-sm";
                row.innerHTML = `
                    <td class="p-3 border-b text-gray-500">${index + 1}</td>
                    <td class="p-3 border-b font-medium">${item.name}</td>
                    <td class="p-3 border-b">${item.position}</td>
                    <td class="p-3 border-b">
                        <div class="text-xs text-gray-600">${item.phone}</div>
                        <div class="text-xs text-blue-600 font-medium">${item.email}</div>
                    </td>
                    <td class="p-3 border-b">
                        <img src="${item.signature}" class="h-10 border bg-white" alt="Sign">
                    </td>
                    <td class="p-3 border-b no-print">
                        <button onclick="window.deleteEntry('${item.id}')" class="text-red-500 hover:text-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.deleteEntry = async (id) => {
            if (!confirm('Padam rekod ini daripada storan awan?')) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id);
                await deleteDoc(docRef);
            } catch (error) {
                alert("Ralat memadam data: " + error.message);
            }
        };

        initAuth();
    </script>
</body>
</html>
