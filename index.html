<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Mesyuarat Agung Tahunan 2026 - Koperasi Adham</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: Corporate Trust (Slate, White, and Royal Blue) -->
    
    <!-- Application Structure Plan: 
         SPA ini direka untuk menguruskan data kehadiran mesyuarat secara spesifik. 
         Bahagian Admin kini mempunyai arkib yang disembunyikan secara lalai. Admin perlu mengklik folder mesyuarat untuk melihat butiran.
         Sistem kini dikonfigurasikan untuk menapis data hanya bagi tarikh 01 Jan 2026 bagi pengiraan status live.
    -->

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #334155; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .signature-box {
            background-color: #ffffff;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: crosshair;
        }

        .print-header { display: none; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-header { 
                display: block !important; 
                text-align: center; 
                margin-bottom: 2rem;
                border-bottom: 2px solid #334155;
                padding-bottom: 1rem;
            }
            body { background: white; padding: 0; }
            .glass-card { box-shadow: none; border: none !important; width: 100%; }
            main { margin-top: 0 !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            th, td { border: 1px solid #cbd5e1 !important; padding: 8px !important; }
            th { background-color: #f1f5f9 !important; }
            img { max-height: 80px !important; }
            @page { margin: 1.5cm; }
            .print-details {
                text-align: left;
                display: inline-block;
                margin: 1rem auto;
                font-size: 0.9rem;
                line-height: 1.6;
            }
            #meetingArchiveSection { display: none !important; }
            #detailedRecordView { display: block !important; }
        }
        
        .table-scroll::-webkit-scrollbar { height: 6px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .archive-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .archive-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- HEADER KHAS UNTUK CETAKAN -->
    <div class="print-header">
        <img src="https://i.postimg.cc/yNSrvgJJ/Logo-Koperasi-Adham-Al-Husainy-Berhad.png" alt="Logo Koperasi" class="mx-auto h-24 mb-4">
        <h1 class="text-xl font-bold uppercase">MESYUARAT AGUNG TAHUNAN</h1>
        <h2 class="text-lg font-semibold">Koperasi Adham Al-Husainy Berhad Tahun 2026</h2>
        
        <div class="print-details border-t border-b border-slate-300 py-2 mt-4 px-4">
            <div><strong>TARIKH:</strong> 01 JANUARI 2026 (KHAMIS)</div>
            <div><strong>MASA:</strong> 09:30 PAGI</div>
            <div><strong>TEMPAT:</strong> 657 JALAN STESEN, SUNGAI BAKAP, 14200 SUNGAI JAWI</div>
        </div>
        
        <div class="text-sm mt-4 font-bold underline uppercase tracking-widest">Senarai Kehadiran Rasmi</div>
    </div>

    <!-- HEADER SKRIN (DASHBOARD) -->
    <div class="bg-slate-900 text-white pb-24 pt-12 px-4 no-print relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 text-[200px] font-bold leading-none select-none pointer-events-none">2026</div>
        <div class="max-w-5xl mx-auto text-center relative z-10">
            <div class="inline-block p-4 bg-white rounded-2xl shadow-xl mb-6">
                <img src="https://i.postimg.cc/yNSrvgJJ/Logo-Koperasi-Adham-Al-Husainy-Berhad.png" 
                     alt="Logo Koperasi" class="h-20 md:h-24 object-contain">
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold mb-2 tracking-tight uppercase">Mesyuarat Agung Tahunan</h1>
            <p class="text-blue-200 text-lg md:text-xl font-medium uppercase tracking-wide">Koperasi Adham Al-Husainy Berhad Tahun 2026</p>
        </div>
    </div>

    <!-- KANDUNGAN UTAMA -->
    <main class="flex-grow px-4 -mt-16 pb-12 w-full max-w-5xl mx-auto z-20 relative">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="grid grid-cols-1 lg:grid-cols-3 gap-6 transition-all duration-300 no-print">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-card rounded-2xl p-6 md:p-8">
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800">üìã Butiran Mesyuarat</h2>
                        <span id="systemStatus" class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full uppercase">Menyambung...</span>
                    </div>
                    <p class="text-slate-600 mb-6 leading-relaxed">
                        Sila semak maklumat mesyuarat di bawah. Semua ahli dikehendaki merekodkan kehadiran melalui sistem ini sebagai pengesahan rasmi untuk sesi tahun 2026.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">üìÖ</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Tarikh</div>
                            <div class="font-bold text-slate-800 text-lg">01 JAN 2026</div>
                            <div class="text-xs text-slate-500 uppercase">Khamis</div>
                        </div>
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">‚è∞</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Masa</div>
                            <div class="font-bold text-slate-800 text-lg">09:30 PAGI</div>
                            <div class="text-xs text-slate-500 uppercase">Waktu Tempatan</div>
                        </div>
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <div class="text-2xl mb-2">üìç</div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider">Tempat</div>
                            <div class="font-bold text-slate-800 text-xs leading-tight mb-1 uppercase">657 JALAN STESEN,<br>SUNGAI BAKAP</div>
                            <div class="text-[10px] text-slate-500 uppercase">14200 Sungai Jawi</div>
                        </div>
                    </div>
                </div>

                <button onclick="openModal('regModal')" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-5 px-6 rounded-2xl shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1 flex items-center justify-between group">
                    <div class="text-left">
                        <div class="text-lg uppercase">‚úç Rekod Kehadiran</div>
                        <div class="text-blue-200 text-xs font-normal">Klik di sini untuk mendaftar masuk (01 Jan 2026)</div>
                    </div>
                    <div class="text-2xl bg-white/20 w-10 h-10 rounded-full flex items-center justify-center group-hover:bg-white/30">‚ûú</div>
                </button>
            </div>

            <aside class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Status Kehadiran (01 Jan 2026)</h3>
                <div class="relative mb-4">
                    <span class="text-7xl font-black text-slate-800 tracking-tighter" id="liveCount">0</span>
                    <span class="absolute top-0 right-0 flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
                <p class="text-sm text-slate-500 mb-6">Anggota telah berdaftar</p>
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2 overflow-hidden">
                    <div id="liveProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between w-full text-[10px] text-slate-400 font-bold uppercase">
                    <span>Mula</span>
                    <span>Sasaran Kuorum</span>
                </div>
            </aside>
        </div>

        <!-- ADMIN PANEL VIEW -->
        <div id="adminPanel" class="hidden space-y-6 mt-6 transition-all duration-300">
            <!-- Admin Header -->
            <div class="glass-card p-6 rounded-2xl flex flex-wrap justify-between items-center gap-4 bg-slate-800 text-white no-print">
                <div>
                    <h2 class="text-xl font-bold">üîí Panel Pengurusan Admin</h2>
                    <p class="text-slate-400 text-sm italic">Sila pilih mesyuarat untuk melihat data.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="logout()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold transition-colors">Keluar</button>
                </div>
            </div>

            <!-- RUANGAN ARKIB -->
            <div id="meetingArchiveSection" class="space-y-4 no-print">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-2">Arkib Mesyuarat</h3>
                
                <div onclick="showMeetingDetails()" class="archive-card glass-card p-6 rounded-2xl flex items-center gap-6">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-3xl shadow-inner">
                        üìÅ
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-extrabold text-slate-800 text-lg uppercase leading-tight">Mesyuarat Agung Tahunan Tahun 2026</h4>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs text-slate-500 font-medium uppercase tracking-tighter">
                            <span>üìÖ 01 Jan 2026</span>
                            <span>‚è∞ 09:30 Pagi</span>
                            <span class="text-blue-600">‚óè Klik untuk maklumat lanjut</span>
                        </div>
                    </div>
                    <div class="text-slate-300 text-2xl">‚ûú</div>
                </div>
            </div>

            <!-- RUANGAN DATA TERPERINCI -->
            <div id="detailedRecordView" class="hidden space-y-6 animate-fade-in">
                
                <button onclick="hideMeetingDetails()" class="no-print flex items-center gap-2 text-blue-600 font-bold text-xs uppercase hover:underline mb-2">
                    ‚¨Ö Kembali ke Arkib
                </button>

                <section class="glass-card p-6 rounded-2xl no-print">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h3 class="font-bold text-slate-700">Analisis Kehadiran Mengikut Jawatan</h3>
                        <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Sesi: 01 Jan 2026</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="positionChart"></canvas>
                    </div>
                </section>

                <section class="glass-card p-6 rounded-2xl shadow-none">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div class="bg-blue-600 text-white px-5 py-3 rounded-xl inline-block shadow-md">
                            <h3 class="font-extrabold text-lg uppercase tracking-tight">Mesyuarat Agung Tahunan Tahun 2026 (01 Jan 2026)</h3>
                        </div>
                        <div class="flex gap-2 no-print">
                            <button onclick="window.print()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold transition-colors">üñ® Cetak PDF</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto table-scroll">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs font-bold text-slate-500 uppercase bg-slate-50 border-y border-slate-200">
                                    <th class="py-3 px-4 text-center" style="width: 50px;">Bil</th>
                                    <th class="py-3 px-4">Nama Penuh</th>
                                    <th class="py-3 px-4">Jawatan</th>
                                    <th class="py-3 px-4">Hubungan (Tel/Email)</th>
                                    <th class="py-3 px-4 text-center">T/Tangan</th>
                                    <th class="py-3 px-4 text-right no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="text-sm text-slate-700"></tbody>
                        </table>
                    </div>
                    <div id="noDataMsg" class="hidden text-center py-12 text-slate-400">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <p>Tiada rekod kehadiran ditemui bagi sesi ini.</p>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-auto text-center no-print">
        <p class="text-slate-400 text-xs mb-2 uppercase tracking-wide">&copy; 2026 Koperasi Adham Al-Husainy Berhad. Hak Cipta Terpelihara.</p>
        <button onclick="openModal('loginModal')" class="text-[10px] font-bold text-slate-300 hover:text-slate-500 uppercase tracking-widest transition-colors">
            Akses Pentadbir
        </button>
    </footer>

    <!-- MODAL: BORANG PENDAFTARAN -->
    <div id="regModal" class="fixed inset-0 z-50 hidden no-print">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="closeModal('regModal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto flex flex-col">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 class="font-bold text-lg text-slate-800 uppercase">Borang Kehadiran (01 Jan 2026)</h3>
                    <button onclick="closeModal('regModal')" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                
                <form id="attendForm" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">Nama Penuh</label>
                        <input type="text" id="inpName" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama penuh">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">Jawatan</label>
                        <select id="inpPos" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                            <option value="" disabled selected>Pilih Jawatan</option>
                            <option value="Pengerusi">Pengerusi</option>
                            <option value="Timbalan Pengerusi">Timbalan Pengerusi</option>
                            <option value="Setiausaha">Setiausaha</option>
                            <option value="Bendahari">Bendahari</option>
                            <option value="Anggota Lembaga (ALK)">Anggota Lembaga (ALK)</option>
                            <option value="Pemeriksa Kira-Kira">Pemeriksa Kira-Kira</option>
                            <option value="Ahli Biasa">Ahli Biasa</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <!-- INPUT DINAMIK UNTUK LAIN-LAIN -->
                    <div id="otherPosContainer" class="hidden animate-fade-in">
                        <label class="block text-[10px] font-bold text-blue-500 uppercase mb-1">Nyatakan Jawatan Anda</label>
                        <input type="text" id="inpOtherPos" class="w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="cth: Pengurus Besar">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-slate-500 uppercase mb-1">No. Telefon</label>
                            <input type="tel" id="inpPhone" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="01x-xxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-500 uppercase mb-1">Emel</label>
                            <input type="email" id="inpEmail" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="nama@email.com">
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-bold text-slate-500 uppercase">Tandatangan</label>
                            <button type="button" id="clearSig" class="text-xs text-red-500 font-bold hover:underline">Padam</button>
                        </div>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl h-40 w-full relative signature-box">
                            <canvas id="sigCanvas" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2 transition-all active:scale-95">
                        <span>Hantar Kehadiran</span>
                        <div id="spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: LOG MASUK ADMIN -->
    <div id="loginModal" class="fixed inset-0 z-50 hidden no-print">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeModal('loginModal')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üîê</div>
                <h3 class="font-bold text-xl text-slate-800 mb-2">Akses Pentadbir</h3>
                <p class="text-sm text-slate-500 mb-6">Masukkan kelayakan admin.</p>
                <div class="space-y-3">
                    <input type="text" id="admUser" placeholder="Username" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="password" id="admPass" placeholder="Password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <p id="loginErr" class="hidden text-xs text-red-500 font-bold">Salah maklumat log masuk.</p>
                </div>
                <div class="mt-8 flex gap-3">
                    <button onclick="attemptLogin()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Masuk</button>
                    <button onclick="closeModal('loginModal')" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-200">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdRqF-OMKS4I7gmiJezid0hl3gUOUTOLY",
            authDomain: "kehadiran-mesyuarat-koadham.firebaseapp.com",
            projectId: "kehadiran-mesyuarat-koadham",
            storageBucket: "kehadiran-mesyuarat-koadham.firebasestorage.app",
            messagingSenderId: "159418583096",
            appId: "1:159418583096:web:e6cc1155d3b1f426003ecd",
            measurementId: "G-VJKVPEM18K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID_PATH = 'koperasi-adham-2025'; 

        let currentUser = null;
        let attendanceDataRaw = [];
        let filteredAttendance = [];
        let chartInstance = null;
        let dataUnsubscribe = null;

        const TARGET_DATE_STRING = "2026-01-01";

        const initAuth = async () => {
            const statusEl = document.getElementById('systemStatus');
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    try { await signInWithCustomToken(auth, token); } 
                    catch (e) { await signInAnonymously(auth); }
                } else { await signInAnonymously(auth); }
            } catch (err) {
                statusEl.textContent = "OFFLINE";
                statusEl.className = "px-3 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full uppercase";
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const statusEl = document.getElementById('systemStatus');
            if(user) {
                statusEl.textContent = "ONLINE";
                statusEl.className = "px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full uppercase";
                startDataListener(); 
            }
        });

        function startDataListener() {
            if (dataUnsubscribe) dataUnsubscribe();
            const colRef = collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'attendance');
            dataUnsubscribe = onSnapshot(colRef, (snapshot) => {
                attendanceDataRaw = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                filteredAttendance = attendanceDataRaw.filter(item => {
                    if (!item.createdAt) return false;
                    const dateObj = new Date(item.createdAt.seconds * 1000);
                    const dateStr = dateObj.toISOString().split('T')[0];
                    return dateStr === TARGET_DATE_STRING;
                });

                filteredAttendance.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                updateDashboard();
                if(!document.getElementById('detailedRecordView').classList.contains('hidden')) {
                    renderAdminTable();
                    updateChart();
                }
            });
        }

        function updateDashboard() {
            const count = filteredAttendance.length;
            document.getElementById('liveCount').textContent = count;
            const pct = Math.min((count / 30) * 100, 100);
            document.getElementById('liveProgress').style.width = `${pct}%`;
        }

        const canvas = document.getElementById('sigCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        window.addEventListener('resize', resizeCanvas);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        ['mousedown', 'touchstart'].forEach(evt => 
            canvas.addEventListener(evt, (e) => {
                isDrawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                if(e.type === 'touchstart') e.preventDefault();
            }, {passive: false})
        );

        ['mousemove', 'touchmove'].forEach(evt => 
            canvas.addEventListener(evt, (e) => {
                if(!isDrawing) return;
                const pos = getPos(e);
                ctx.lineWidth = 2.5;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#0f172a';
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                if(e.type === 'touchmove') e.preventDefault();
            }, {passive: false})
        );

        ['mouseup', 'touchend'].forEach(evt => window.addEventListener(evt, () => isDrawing = false));
        document.getElementById('clearSig').onclick = () => ctx.clearRect(0,0, canvas.width, canvas.height);

        // LOGIK DINAMIK UNTUK JAWATAN
        const inpPos = document.getElementById('inpPos');
        const otherPosContainer = document.getElementById('otherPosContainer');
        const inpOtherPos = document.getElementById('inpOtherPos');

        inpPos.addEventListener('change', () => {
            if (inpPos.value === "Lain-lain") {
                otherPosContainer.classList.remove('hidden');
                inpOtherPos.required = true;
            } else {
                otherPosContainer.classList.add('hidden');
                inpOtherPos.required = false;
                inpOtherPos.value = '';
            }
        });

        document.getElementById('attendForm').onsubmit = async (e) => {
            e.preventDefault();
            if(!currentUser) return alert("Sila tunggu sambungan sistem aktif.");
            const blank = document.createElement('canvas');
            blank.width = canvas.width; blank.height = canvas.height;
            if(canvas.toDataURL() === blank.toDataURL()) return alert("Tandatangan diperlukan.");
            
            const btn = document.getElementById('submitBtn');
            const spin = document.getElementById('spinner');
            btn.disabled = true;
            spin.classList.remove('hidden');

            try {
                // Gunakan nilai dari 'Lain-lain' jika ia dipilih
                const finalPosition = (inpPos.value === "Lain-lain") ? inpOtherPos.value : inpPos.value;

                const payload = {
                    name: document.getElementById('inpName').value,
                    position: finalPosition,
                    phone: document.getElementById('inpPhone').value,
                    email: document.getElementById('inpEmail').value,
                    signature: canvas.toDataURL(),
                    createdAt: serverTimestamp(),
                    userId: currentUser.uid
                };
                await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'attendance'), payload);
                closeModal('regModal');
                e.target.reset();
                otherPosContainer.classList.add('hidden');
                ctx.clearRect(0,0, canvas.width, canvas.height);
                alert("Berjaya dihantar.");
            } catch (err) { alert("Ralat menghantar data."); }
            finally { btn.disabled = false; spin.classList.add('hidden'); }
        };

        function updateChart() {
            const ctxChart = document.getElementById('positionChart').getContext('2d');
            const counts = {};
            filteredAttendance.forEach(d => {
                const p = d.position || 'Lain-lain';
                counts[p] = (counts[p] || 0) + 1;
            });
            const labels = Object.keys(counts);
            const vals = Object.values(counts);
            if(chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = vals;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctxChart, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Anggota',
                            data: vals,
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        function renderAdminTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            if(filteredAttendance.length === 0) {
                document.getElementById('noDataMsg').classList.remove('hidden');
                return;
            }
            document.getElementById('noDataMsg').classList.add('hidden');
            filteredAttendance.forEach((item, i) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 px-4 text-center font-mono text-xs text-slate-400">${filteredAttendance.length - i}</td>
                    <td class="py-3 px-4 font-bold text-slate-700">${item.name}</td>
                    <td class="py-3 px-4"><span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-tighter">${item.position}</span></td>
                    <td class="py-3 px-4 text-xs">
                        <div class="font-medium">${item.phone}</div>
                        <div class="text-slate-400 font-light">${item.email}</div>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <img src="${item.signature}" class="h-10 mx-auto border border-slate-200 bg-white rounded shadow-sm">
                    </td>
                    <td class="py-3 px-4 text-right no-print">
                        <button onclick="window.delEntry('${item.id}')" class="text-slate-300 hover:text-red-500 transition-colors">üóë</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.delEntry = async (id) => {
            if(confirm("Padam rekod?")) await deleteDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'attendance', id));
        };

        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            if(id === 'regModal') setTimeout(resizeCanvas, 300);
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if(id === 'regModal') {
                otherPosContainer.classList.add('hidden');
                document.getElementById('attendForm').reset();
            }
        };

        window.attemptLogin = () => {
            const u = document.getElementById('admUser').value;
            const p = document.getElementById('admPass').value;
            if(u === 'Admin' && p === 'Admin123') {
                closeModal('loginModal');
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                hideMeetingDetails();
            } else { document.getElementById('loginErr').classList.remove('hidden'); }
        };

        window.logout = () => {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
        };

        window.showMeetingDetails = () => {
            document.getElementById('meetingArchiveSection').classList.add('hidden');
            document.getElementById('detailedRecordView').classList.remove('hidden');
            updateChart();
            renderAdminTable();
        };

        window.hideMeetingDetails = () => {
            document.getElementById('detailedRecordView').classList.add('hidden');
            document.getElementById('meetingArchiveSection').classList.remove('hidden');
        };

        initAuth();
    </script>
</body>
</html>
